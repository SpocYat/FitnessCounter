<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spocademy Fitness Journey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
            color: #212529;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #007fff, #0056cc);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 127, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .brand {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
        }
        
        .tagline {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .track-container {
            position: relative;
            margin: 40px 0;
        }
        
        .track {
            width: 6px;
            height: 200px;
            background: linear-gradient(180deg, #e9ecef, #dee2e6);
            margin: 0 auto;
            border-radius: 10px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .milestone {
            position: absolute;
            width: 120px;
            height: 80px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .milestone:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 127, 255, 0.2);
            border-color: #007fff;
        }
        
        .milestone.completed {
            background: linear-gradient(135deg, #007fff, #0056cc);
            border-color: #007fff;
            color: white;
        }
        
        .milestone.current {
            background: linear-gradient(135deg, #28a745, #20c997);
            border-color: #28a745;
            color: white;
            animation: pulse 2s infinite;
        }
        
        .milestone.locked {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f8f9fa;
            color: #adb5bd;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        
        .day-number {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .progress-ring {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 40px;
            height: 40px;
        }
        
        .progress-ring circle {
            stroke-width: 4;
            fill: transparent;
            r: 16;
            cx: 20;
            cy: 20;
        }
        
        .progress-ring-bg {
            stroke: #e9ecef;
        }
        
        .progress-ring-fill {
            stroke: #007fff;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dasharray 0.3s;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 40px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #007fff;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }

        .fitness-tracker {
            display: none;
        }
    </style>
</head>
<body>
    <div id="progressPage">
        <div class="container">
            <div class="header">
                <div class="brand">üèÉ‚Äç‚ôÇÔ∏è SPOCADEMY FITNESS JOURNEY</div>
                <div class="tagline">Your 30-Day Transformation Challenge</div>
            </div>
            
            <div class="track-container">
                <div class="track" id="track"></div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalDaysCompleted">0</div>
                    <div class="stat-label">Days Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="currentStreakDisplay">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalActivitiesDisplay">0</div>
                    <div class="stat-label">Total Activities</div>
                </div>
            </div>
        </div>
    </div>

    <div id="fitnessTracker" class="fitness-tracker">
        <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
        
        <style>
            .fitness-tracker { 
                display: block; 
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%); 
                z-index: 2000; 
                overflow-y: auto; 
            }
            .return-btn { 
                position: fixed; 
                top: 20px; 
                left: 20px; 
                z-index: 1001; 
                background: #007fff; 
                color: white; 
                border: none; 
                padding: 12px 20px; 
                border-radius: 10px; 
                cursor: pointer; 
                font-weight: 600;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 127, 255, 0.3);
            }
            .return-btn:hover {
                background: #0056cc;
                transform: translateY(-2px);
            }
            .fitness-container { 
                max-width: 1200px; 
                margin: 0 auto; 
                padding: 20px; 
            }
            .fitness-header { 
                text-align: center; 
                margin-bottom: 40px; 
                background: linear-gradient(135deg, #007fff, #0056cc); 
                padding: 30px; 
                border-radius: 20px; 
                box-shadow: 0 10px 30px rgba(0, 127, 255, 0.15); 
                color: white;
            }
            .fitness-brand { 
                font-size: 42px; 
                font-weight: 700; 
                margin-bottom: 10px; 
            }
            .fitness-tagline { 
                font-size: 18px; 
                opacity: 0.9; 
            }
            .streak-info { 
                display: flex; 
                justify-content: center; 
                gap: 20px; 
                margin-bottom: 40px; 
                flex-wrap: wrap; 
            }
            .streak-card { 
                background: white; 
                border: 2px solid #e9ecef; 
                border-radius: 20px; 
                padding: 25px; 
                text-align: center; 
                min-width: 160px; 
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
            }
            .streak-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }
            .streak-number { 
                font-size: 36px; 
                font-weight: 700; 
                color: #007fff; 
                margin-bottom: 8px; 
            }
            .streak-label { 
                color: #6c757d; 
                font-size: 14px; 
                font-weight: 600; 
            }
            .tasks-grid { 
                display: grid; 
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
                gap: 25px; 
                margin-bottom: 30px; 
            }
            .task-card { 
                background: white; 
                border-radius: 20px; 
                padding: 30px; 
                border: 2px solid #e9ecef; 
                transition: all 0.4s ease; 
                position: relative; 
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            .task-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }
            .task-card.completed { 
                border-color: #28a745; 
                background: linear-gradient(135deg, #28a745, #20c997); 
                color: white;
            }
            .task-card.completed .task-title,
            .task-card.completed .task-description {
                color: white;
            }
            .task-header { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                margin-bottom: 20px; 
            }
            .task-title { 
                font-size: 22px; 
                font-weight: 700; 
                color: #212529; 
            }
            .task-status { 
                width: 35px; 
                height: 35px; 
                border-radius: 50%; 
                border: 3px solid #28a745; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                font-size: 18px; 
                font-weight: bold; 
                color: #28a745;
            }
            .task-status.completed { 
                background: #28a745; 
                color: white; 
            }
            .task-description { 
                margin-bottom: 20px; 
                color: #6c757d; 
                font-size: 16px; 
                line-height: 1.5;
            }
            .task-progress { 
                display: none; 
            }
            .day-progress { 
                width: 100%; 
                height: 8px; 
                background: rgba(255, 255, 255, 0.3); 
                border-radius: 10px; 
                margin: 15px 0; 
                overflow: hidden;
            }
            .day-progress-fill { 
                height: 100%; 
                background: linear-gradient(90deg, #28a745, #20c997); 
                border-radius: 10px; 
                width: 0%; 
                transition: width 0.5s ease; 
            }
            .task-actions { 
                display: flex; 
                gap: 10px; 
                flex-wrap: wrap; 
            }
            .btn { 
                padding: 14px 22px; 
                border: none; 
                border-radius: 12px; 
                cursor: pointer; 
                font-size: 15px; 
                font-weight: 600; 
                transition: all 0.3s ease; 
            }
            .primary-btn { 
                background: linear-gradient(135deg, #007fff, #0056cc); 
                color: white; 
                box-shadow: 0 4px 12px rgba(0, 127, 255, 0.3);
            }
            .primary-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 127, 255, 0.4);
            }
            .secondary-btn { 
                background: white; 
                color: #007fff; 
                border: 2px solid #007fff; 
            }
            .secondary-btn:hover {
                background: #007fff;
                color: white;
                transform: translateY(-2px);
            }
            .manual-btn { 
                background: #6c757d; 
                color: white; 
                font-size: 12px; 
                padding: 8px 12px; 
            }
            .manual-btn:hover {
                background: #495057;
                transform: translateY(-2px);
            }
            .voice-prompt { 
                position: fixed; 
                top: 50%; 
                left: 50%; 
                transform: translate(-50%, -50%); 
                background: white; 
                padding: 40px; 
                border-radius: 20px; 
                text-align: center; 
                z-index: 3000; 
                display: none; 
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
                border: 2px solid #e9ecef;
                color: #212529;
            }
            .voice-animation { 
                width: 100px; 
                height: 100px; 
                border: 3px solid #007fff; 
                border-radius: 50%; 
                margin: 20px auto; 
                animation: pulse 1s infinite; 
            }
            .camera-section { 
                display: none; 
                background: rgba(248, 249, 250, 0.98); 
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                z-index: 1500; 
                padding: 20px; 
                backdrop-filter: blur(10px);
            }
            .camera-container { 
                max-width: 900px; 
                margin: 20px auto; 
                text-align: center; 
                background: white; 
                border-radius: 25px; 
                padding: 30px; 
                border: 2px solid #e9ecef; 
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            }
            .exercise-counter { 
                font-size: 56px; 
                color: #007fff; 
                margin: 20px 0; 
                font-weight: 700; 
            }
            .target-info { 
                font-size: 28px; 
                margin-bottom: 20px; 
                color: #212529; 
                font-weight: 600;
            }
            .exercise-status { 
                font-size: 20px; 
                color: #6c757d; 
                margin-bottom: 20px; 
                min-height: 30px; 
            }
            #videoElement { 
                width: 100%; 
                max-width: 640px; 
                border: 4px solid #007fff; 
                border-radius: 15px; 
            }
            .video-container { 
                position: relative; 
                display: inline-block; 
                margin: 25px 0; 
            }
            #canvas {
                position: absolute;
                top: 4px;
                left: 50%;
                transform: translateX(-50%);
                pointer-events: none;
                border-radius: 11px;
            }
            .completion-message { 
                display: none; 
                background: linear-gradient(135deg, #28a745, #20c997); 
                color: white; 
                padding: 20px; 
                border-radius: 15px; 
                margin: 20px 0; 
                font-size: 24px; 
                font-weight: 700; 
            }
            .congratulations { 
                display: none; 
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: rgba(248, 249, 250, 0.98); 
                z-index: 2500; 
                align-items: center; 
                justify-content: center; 
                flex-direction: column; 
                text-align: center; 
                backdrop-filter: blur(10px);
            }
            .congrats-content { 
                max-width: 600px; 
                padding: 50px; 
                background: white; 
                border-radius: 25px; 
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
                border: 2px solid #e9ecef;
            }
            .congrats-title { 
                font-size: 48px; 
                color: #28a745; 
                margin-bottom: 20px; 
                font-weight: 700;
            }
            .congrats-content h2 {
                color: #212529;
                margin-bottom: 20px;
            }
            .congrats-content p {
                color: #6c757d;
            }
        </style>

        <button class="return-btn" onclick="returnToMain()">‚Üê Back to Journey</button>
        <div class="fitness-container">
            <div class="fitness-header">
                <div class="fitness-brand">SPOCADEMY</div>
                <div class="fitness-tagline" id="dayTitle">Daily Fitness Challenge</div>
                <div class="day-progress">
                    <div class="day-progress-fill" id="dayProgressBar"></div>
                </div>
                <div style="text-align: center; margin-top: 10px; font-size: 18px;" id="dayProgressText">0% Complete</div>
            </div>
            
            <div class="streak-info">
                <div class="streak-card"><div class="streak-number" id="currentStreak">0</div><div class="streak-label">Current Streak</div></div>
                <div class="streak-card"><div class="streak-number" id="totalDays">0</div><div class="streak-label">Total Days</div></div>
                <div class="streak-card"><div class="streak-number" id="completedToday">0/4</div><div class="streak-label">Today's Progress</div></div>
            </div>
            
            <div class="tasks-grid">
                <div class="task-card" id="task1">
                    <div class="task-header"><div class="task-title">üèÉ‚Äç‚ôÇÔ∏è Run 100m</div><div class="task-status" id="status1">‚óã</div></div>
                    <div class="task-description">Complete a 100 meter run outdoors or on treadmill</div>
                    <div class="task-actions"><button class="btn secondary-btn" onclick="markTaskComplete(1)">‚úì Mark Complete</button></div>
                </div>
                
                <div class="task-card" id="task2">
                    <div class="task-header"><div class="task-title">ü¶µ 5 Squats</div><div class="task-status" id="status2">‚óã</div></div>
                    <div class="task-description">Complete 5 perfect squats using AI detection</div>
                    <div class="task-actions">
                        <button class="btn primary-btn" onclick="startExercise('squats', 5, 2)">üìπ Start Camera</button>
                        <button class="btn manual-btn" onclick="markTaskComplete(2)">Manual ‚úì</button>
                    </div>
                </div>
                
                <div class="task-card" id="task3">
                    <div class="task-header"><div class="task-title">ü§∏‚Äç‚ôÇÔ∏è 5 Jumping Jacks</div><div class="task-status" id="status3">‚óã</div></div>
                    <div class="task-description">Complete 5 jumping jacks using AI detection</div>
                    <div class="task-actions">
                        <button class="btn primary-btn" onclick="startExercise('jumping-jacks', 5, 3)">üìπ Start Camera</button>
                        <button class="btn manual-btn" onclick="markTaskComplete(3)">Manual ‚úì</button>
                    </div>
                </div>
                
                <div class="task-card" id="task4">
                    <div class="task-header"><div class="task-title">üíß Drink 3L Water</div><div class="task-status" id="status4">‚óã</div></div>
                    <div class="task-description">Stay hydrated throughout the day - track your water intake</div>
                    <div class="task-actions"><button class="btn secondary-btn" onclick="markTaskComplete(4)">‚úì Mark Complete</button></div>
                </div>
            </div>
        </div>
        
        <div class="voice-prompt" id="voicePrompt" style="display: none;">
            <h2>Are you ready to start?</h2>
            <div class="voice-animation"></div>
            <p>Say "Yes" to begin</p>
            <button class="btn secondary-btn" onclick="cancelVoice()">Cancel</button>
        </div>
        
        <div class="camera-section" id="cameraSection">
            <div class="camera-container">
                <h2 id="exerciseTitle">Exercise Counter</h2>
                <div class="exercise-counter" id="exerciseCounter">0</div>
                <div class="target-info" id="targetInfo">Target: 0</div>
                <div class="exercise-status" id="exerciseStatus">Get ready...</div>
                <div class="completion-message" id="completionMessage">üéâ EXCELLENT! Task Completed! üéâ</div>
                <div class="video-container">
                    <video id="videoElement" autoplay muted playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                <button class="btn secondary-btn" onclick="closeCamera()">‚úñ Close</button>
            </div>
        </div>
        
        <div class="congratulations" id="congratulations">
            <div class="congrats-content">
                <div class="congrats-title">üéâ AMAZING! üéâ</div>
                <h2>You completed all tasks for today!</h2>
                <p style="margin: 20px 0; font-size: 18px;">Keep up the incredible work! Your streak continues.</p>
                <button class="btn primary-btn" onclick="returnToMain()">üöÄ Continue Journey</button>
            </div>
        </div>
    </div>

    <script>
        // Use regular variables instead of localStorage
        let progressData = {};
        let currentDay = 1;
        let selectedDay = 1;
        
        // Fitness tracker variables
        let currentExercise = null, targetCount = 0, exerciseCount = 0, taskToComplete = 0;
        let pose, camera, recognition, voiceInterval, audioContext;
        let hasGoneDown = false, armsUp = false, legsApart = false, hasCompletedJump = false;
        let tasksCompleted = [false, false, false, false];
        
        function initializeProgress() {
            const track = document.getElementById('track');
            track.innerHTML = '';
            
            for (let day = 1; day <= 7; day++) {
                const milestone = document.createElement('div');
                milestone.className = 'milestone';
                milestone.style.top = `${(day - 1) * 30}px`;
                
                if (day % 2 === 0) {
                    milestone.style.right = '-60px';
                } else {
                    milestone.style.left = '-60px';
                }
                
                const dayData = progressData[day] || { completed: false, progress: 0 };
                
                if (dayData.completed) {
                    milestone.classList.add('completed');
                } else if (day === currentDay) {
                    milestone.classList.add('current');
                } else if (day > currentDay) {
                    milestone.classList.add('locked');
                }
                
                const circumference = 2 * Math.PI * 16;
                const strokeDasharray = `${(dayData.progress / 100) * circumference} ${circumference}`;
                
                milestone.innerHTML = `
                    <div class="day-number">Day ${day}</div>
                    <div style="font-size: 12px;">${Math.round(dayData.progress)}%</div>
                    <svg class="progress-ring">
                        <circle class="progress-ring-bg" stroke-dasharray="${circumference}" stroke-dashoffset="0"/>
                        <circle class="progress-ring-fill" stroke-dasharray="${strokeDasharray}" stroke-dashoffset="0"/>
                    </svg>
                `;
                
                if (!milestone.classList.contains('locked')) {
                    milestone.addEventListener('click', () => startDay(day));
                }
                
                track.appendChild(milestone);
            }
            
            updateMainStats();
        }
        
        function updateMainStats() {
            const completedDays = Object.values(progressData).filter(day => day.completed).length;
            const totalActivities = Object.values(progressData).reduce((sum, day) => sum + (day.activitiesCompleted || 0), 0);
            
            let streak = 0;
            for (let day = currentDay - 1; day >= 1; day--) {
                if (progressData[day] && progressData[day].completed) {
                    streak++;
                } else {
                    break;
                }
            }
            
            document.getElementById('totalDaysCompleted').textContent = completedDays;
            document.getElementById('currentStreakDisplay').textContent = streak;
            document.getElementById('totalActivitiesDisplay').textContent = totalActivities;
        }
        
        function startDay(day) {
            if (day > currentDay) return;
            
            selectedDay = day;
            const dayData = progressData[day] || { completed: false, progress: 0, tasksCompleted: [false, false, false, false] };
            tasksCompleted = dayData.tasksCompleted || [false, false, false, false];
            
            document.getElementById('progressPage').style.display = 'none';
            document.getElementById('fitnessTracker').style.display = 'block';
            document.getElementById('dayTitle').textContent = `Daily Fitness Challenge - Day ${day}`;
            
            updateFitnessUI();
        }
        
        function updateFitnessUI() {
            const completed = tasksCompleted.filter(task => task).length;
            const progress = (completed / 4) * 100;
            
            document.getElementById('completedToday').textContent = `${completed}/4`;
            document.getElementById('dayProgressBar').style.width = `${progress}%`;
            document.getElementById('dayProgressText').textContent = `${Math.round(progress)}% Complete`;
            
            tasksCompleted.forEach((completed, index) => {
                const taskCard = document.getElementById(`task${index + 1}`);
                const statusIcon = document.getElementById(`status${index + 1}`);
                
                if (completed) {
                    taskCard.classList.add('completed');
                    statusIcon.textContent = '‚úì';
                    statusIcon.classList.add('completed');
                } else {
                    taskCard.classList.remove('completed');
                    statusIcon.textContent = '‚óã';
                    statusIcon.classList.remove('completed');
                }
            });
        }
        
        function markTaskComplete(taskNumber) {
            tasksCompleted[taskNumber - 1] = true;
            updateFitnessUI();
            checkAllTasksComplete();
        }
        
        function checkAllTasksComplete() {
            if (tasksCompleted.every(task => task)) {
                setTimeout(() => document.getElementById('congratulations').style.display = 'flex', 1000);
            }
        }
        
        function returnToMain() {
            const completedCount = tasksCompleted.filter(task => task).length;
            const progress = (completedCount / 4) * 100;
            const isCompleted = completedCount === 4;
            
            progressData[selectedDay] = {
                completed: isCompleted,
                progress: progress,
                activitiesCompleted: completedCount,
                tasksCompleted: tasksCompleted
            };
            
            if (isCompleted && selectedDay === currentDay) {
                currentDay++;
            }
            
            document.getElementById('fitnessTracker').style.display = 'none';
            document.getElementById('progressPage').style.display = 'block';
            document.getElementById('congratulations').style.display = 'none';
            
            initializeProgress();
        }
        
        function startExercise(exercise, target, taskNum) {
            currentExercise = exercise;
            targetCount = target;
            taskToComplete = taskNum;
            actuallyStartExercise();
        }
        
        function actuallyStartExercise() {
            exerciseCount = 0;
            hasGoneDown = false;
            armsUp = false;
            legsApart = false;
            hasCompletedJump = false;
            
            document.getElementById('exerciseTitle').textContent = 
                currentExercise === 'squats' ? 'ü¶µ Squat Counter' : 'ü§∏‚Äç‚ôÇÔ∏è Jumping Jacks Counter';
            document.getElementById('targetInfo').textContent = `Target: ${targetCount}`;
            document.getElementById('exerciseCounter').textContent = '0';
            document.getElementById('exerciseStatus').textContent = 'Starting camera...';
            document.getElementById('completionMessage').style.display = 'none';
            document.getElementById('cameraSection').style.display = 'block';
            
            startCamera();
        }
        
        function startCamera() {
            if (typeof Pose === 'undefined') {
                document.getElementById('exerciseStatus').textContent = 'Loading AI model...';
                setTimeout(startCamera, 1000);
                return;
            }

            pose = new Pose({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
            });
            
            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: false,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            pose.onResults(onResults);
            
            const videoElement = document.getElementById('videoElement');
            if (typeof Camera !== 'undefined') {
                camera = new Camera(videoElement, {
                    onFrame: async () => { 
                        if (pose) await pose.send({image: videoElement}); 
                    },
                    width: 640,
                    height: 480
                });
                
                camera.start();
                document.getElementById('exerciseStatus').textContent = 'Camera started! Begin exercising! üí™';
            } else {
                document.getElementById('exerciseStatus').textContent = 'Camera unavailable. Please try manual completion.';
            }
        }
        
        function closeCamera() {
            document.getElementById('cameraSection').style.display = 'none';
            if (camera) {
                camera.stop();
                camera = null;
            }
            if (recognition) {
                recognition.stop();
                clearInterval(voiceInterval);
            }
        }
        
        function playBeep() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }
        
        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }
        
        function detectSquats(results) {
            const landmarks = results.poseLandmarks;
            const leftHip = landmarks[23], leftKnee = landmarks[25], leftAnkle = landmarks[27];
            const rightHip = landmarks[24], rightKnee = landmarks[26], rightAnkle = landmarks[28];
            
            if (![leftHip, leftKnee, leftAnkle, rightHip, rightKnee, rightAnkle].every(part => part && part.visibility > 0.5)) {
                document.getElementById('exerciseStatus').textContent = 'Step back and show your full body';
                return;
            }
            
            const leftKneeAngle = calculateAngle(leftHip, leftKnee, leftAnkle);
            const rightKneeAngle = calculateAngle(rightHip, rightKnee, rightAnkle);
            const bothKneesBent = leftKneeAngle < 120 && rightKneeAngle < 120;
            const bothKneesUp = leftKneeAngle > 150 && rightKneeAngle > 150;
            
            if (bothKneesBent && !hasGoneDown) {
                hasGoneDown = true;
                document.getElementById('exerciseStatus').textContent = 'Going down... Perfect! üí™';
            } else if (bothKneesUp && hasGoneDown) {
                hasGoneDown = false;
                exerciseCount++;
                document.getElementById('exerciseCounter').textContent = exerciseCount;
                playBeep();
                
                if (exerciseCount >= targetCount) {
                    document.getElementById('exerciseStatus').textContent = 'üéâ TARGET ACHIEVED! üéâ';
                    document.getElementById('completionMessage').style.display = 'block';
                    markTaskComplete(taskToComplete);
                    setTimeout(() => closeCamera(), 3000);
                } else {
                    document.getElementById('exerciseStatus').textContent = `${targetCount - exerciseCount} more squats! üî•`;
                }
            }
        }
        
        function detectJumpingJacks(results) {
            const landmarks = results.poseLandmarks;
            const leftShoulder = landmarks[11], rightShoulder = landmarks[12];
            const leftWrist = landmarks[15], rightWrist = landmarks[16];
            const leftAnkle = landmarks[27], rightAnkle = landmarks[28];
            
            if (![leftShoulder, rightShoulder, leftWrist, rightWrist, leftAnkle, rightAnkle].every(part => part && part.visibility > 0.5)) {
                document.getElementById('exerciseStatus').textContent = 'Step back and show your full body';
                return;
            }
            
            const currentArmsUp = leftWrist.y < leftShoulder.y && rightWrist.y < rightShoulder.y;
            const ankleDistance = Math.abs(leftAnkle.x - rightAnkle.x);
            const shoulderDistance = Math.abs(leftShoulder.x - rightShoulder.x);
            const currentLegsApart = ankleDistance > shoulderDistance * 1.5;
            
            if (currentArmsUp && currentLegsApart && !hasCompletedJump) {
                armsUp = true;
                legsApart = true;
                document.getElementById('exerciseStatus').textContent = 'Perfect position! üôå';
            } else if (!currentArmsUp && !currentLegsApart && armsUp && legsApart) {
                hasCompletedJump = true;
                armsUp = false;
                legsApart = false;
                exerciseCount++;
                document.getElementById('exerciseCounter').textContent = exerciseCount;
                playBeep();
                
                if (exerciseCount >= targetCount) {
                    document.getElementById('exerciseStatus').textContent = 'üéâ TARGET ACHIEVED! üéâ';
                    document.getElementById('completionMessage').style.display = 'block';
                    markTaskComplete(taskToComplete);
                    setTimeout(() => closeCamera(), 3000);
                } else {
                    document.getElementById('exerciseStatus').textContent = `${targetCount - exerciseCount} more jumping jacks! üî•`;
                }
                
                setTimeout(() => { hasCompletedJump = false; }, 500);
            }
        }
        
        function onResults(results) {
            const canvas = document.getElementById('canvas');
            const canvasCtx = canvas.getContext('2d');
            const video = document.getElementById('videoElement');
            
            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Clear canvas
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (results.poseLandmarks) {
                // Draw pose landmarks and connections
                if (typeof drawConnectors !== 'undefined' && typeof POSE_CONNECTIONS !== 'undefined') {
                    drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#007fff', lineWidth: 3});
                }
                if (typeof drawLandmarks !== 'undefined') {
                    drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2, radius: 4});
                }
                
                // Detect exercises
                if (currentExercise === 'squats') {
                    detectSquats(results);
                } else if (currentExercise === 'jumping-jacks') {
                    detectJumpingJacks(results);
                }
            }
            
            canvasCtx.restore();
        }
        
        function cancelVoice() {
            document.getElementById('voicePrompt').style.display = 'none';
            if (recognition) {
                recognition.stop();
                clearInterval(voiceInterval);
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeProgress();
        });
    </script>
</body>
</html>
